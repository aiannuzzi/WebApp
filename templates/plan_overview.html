{% extends "base.html" %}

{% block title %}
Plan Overview
{% endblock %}

{% block content %}
<div class="container mt-4">
    <form action="{{ url_for('save_plan_overview', client_id=client_id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs nav-tabs-scrollable" id="planTabs" role="tablist">
            {% for plan_id, plan_info in plan_data.items() %}
                {% set tab_id = (plan_id if plan_id else plan_info.name.replace(' ', '_')) ~ '_' ~ loop.index %}
                <li class="nav-item" role="presentation">
                    <button 
                        class="nav-link {% if loop.first %}active{% endif %}" 
                        id="tab-{{ tab_id }}" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-{{ tab_id }}" 
                        type="button" 
                        role="tab" 
                        aria-controls="content-{{ tab_id }}" 
                        aria-selected="{{ 'true' if loop.first else 'false' }}"
                        data-plan-name="{{ plan_info['name'] }}"
                        data-start-date="{{ plan_info.get('start_date', 'N/A') }}"
                        data-end-date="{{ plan_info.get('end_date', 'N/A') }}">
                        {{ plan_info['name'] }}
                    </button>
                </li>
            {% endfor %}

            

                <!-- Summary Tab -->
                <li class="nav-item" role="presentation">
                    <button 
                        class="nav-link" 
                        id="tab-summary" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-summary" 
                        type="button" 
                        role="tab" 
                        aria-controls="content-summary" 
                        aria-selected="false">
                        Summary
                    </button>
                </li>


        </ul>

        <div class="tab-content" id="planTabsContent">
            {% for plan_id, plan_info in plan_data.items() %}
                {% set tab_id = (plan_id if plan_id else plan_info.name.replace(' ', '_')) ~ '_' ~ loop.index %}

                <div 
                    class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                    id="content-{{ tab_id }}" 
                    role="tabpanel" 
                    aria-labelledby="tab-{{ tab_id }}"
                    data-start-date="{{ plan_info.get('start_date', 'N/A') }}"
                    data-end-date="{{ plan_info.get('end_date', 'N/A') }}"
                    data-rate-combinations="{{ plan_info.get('rate_combinations', 'N/A') }}"
                    >
                    
                    <!-- Plan Overview Section -->
                    <div class="card mt-4 mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Plan Overview - {{ plan_info.name }}</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Plan Name</th>
                                        <th>Line of Coverage</th>
                                        <th>Funding Type</th>
                                        <th>Plan Type</th>
                                        <th>Primary Carrier</th>
                                        <th>Alternate Carrier</th>
                                        
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Plan Name -->
                                        
                                        <td>
                                            <input 
                                                type="text" 
                                                name="plans[{{ tab_id }}][plan_name]" 
                                                class="form-control" 
                                                value="{{ plan_info.name }}" 
                                                placeholder="Enter Plan Name"
                                                data-summary="{{ plan_info.name }}" >
                                        </td>
                                        <!-- Line of Coverage -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="plans[{{ tab_id }}][loc]" 
                                                class="form-control" 
                                                value="{{ plan_info.loc }}" 
                                                placeholder="Enter Line of Coverage"
                                                data-sumamry="{{ plan_info.loc }}">
                                        </td>
                                        <!-- Funding Type -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="plans[{{ tab_id }}][funding_type]" 
                                                class="form-control" 
                                                value="{{ plan_info.funding_type }}" 
                                                placeholder="Enter Funding Type"
                                                data-summary="{{ plan_info.funding_type }}">
                                        </td>
                                        <!--PlanType-->
                                        <td>
                                            <select name="plans[{{ tab_id }}][plan_type]" class="form-control plan-type-dropdown" data-summary="{{plan_info.plan_type}}">
                                                <option value="" {% if not plan_info.plan_type %}selected{% endif %}>Select Plan Type</option>
                                                <option value="EPO" {% if plan_info.plan_type == 'EPO' %}selected{% endif %}>EPO</option>
                                                <option value="HDHP - HRA" {% if plan_info.plan_type == 'HDHP - HRA' %}selected{% endif %}>HDHP - HRA</option>
                                                <option value="HDHP - HSA" {% if plan_info.plan_type == 'HDHP - HSA' %}selected{% endif %}>HDHP - HSA</option>
                                                <option value="HMO" {% if plan_info.plan_type == 'HMO' %}selected{% endif %}>HMO</option>
                                                <option value="OTHER" {% if plan_info.plan_type == 'OTHER' %}selected{% endif %}>OTHER</option>
                                                <option value="POS" {% if plan_info.plan_type == 'POS' %}selected{% endif %}>POS</option>
                                                <option value="PPO" {% if plan_info.plan_type == 'PPO' %}selected{% endif %}>PPO</option>
                                            </select>
                                        </td>
                                        
                                        <!-- Primary Carrier -->
                                        <td>
                                            <select name="plans[{{ tab_id }}][primary_carrier]" class="form-control primary-carrier-dropdown" data-summary="{{plan_info.carrier}}">
                                                <option value="">Select Primary Carrier</option>
                                                {% if plan_info.loc in carriers_by_loc %}
                                                    {% for carrier in carriers_by_loc[plan_info.loc] %}
                                                        <option value="{{ carrier }}" {% if plan_info.carrier == carrier %}selected{% endif %}>
                                                            {{ carrier }}
                                                        </option>
                                                    {% endfor %}
                                                {% else %}
                                                    <option value="" disabled>No carriers available</option>
                                                {% endif %}
                                            </select>
                                        </td>

                                        <!-- Alternate Carrier -->
                                        <td>
                                            <select name="plans[{{ tab_id}}][alternate_carrier]" class="form-control alternate-carrier-dropdown" data-summary="{{plan_info.alternate_carrier}}">
                                                <option value="">Select Alternate Carrier</option>
                                                {% if plan_info.loc in carriers_by_loc %}
                                                    {% for carrier in carriers_by_loc[plan_info.loc] %}
                                                        <option value="{{ carrier }}" {% if plan_info.alternate_carrier == carrier %}selected{% endif %}>
                                                            {{ carrier }}
                                                        </option>
                                                    {% endfor %}
                                                {% else %}
                                                    <option value="" disabled>No carriers available</option>
                                                {% endif %}
                                            </select>
                                        </td>

                                        <input 
                                            type="hidden" 
                                            name="plans[{{ tab_id }}][start_date]" 
                                            value="{{ plan_info.get('start_date', '') }}" 
                                        />


            
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Premiums Section -->
                    {% if ("Self" in plan_info['funding_type'] or "Fully" in plan_info['funding_type'] or "Level" in plan_info['funding_type']) %}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Premiums - Monthly</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Premium Rate Description</th>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <th>Tier {{ i }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rate in plan_info['rate_combinations'] %}
                                    <tr>
                                        <td>{{ rate }}</td>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <td>
                                                <input type="text" name="premium_tier{{ i }}_{{ tab_id }}_{{ loop.index }}" class="form-control form-control-sm" placeholder="Enter value" data-summary="Enter Value">
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Contributions Section -->
                    {% if ("Self" in plan_info['funding_type'] or "Fully" in plan_info['funding_type'] or "Level" in plan_info['funding_type'] ) %}

                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Contributions - Monthly</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th> Contributions Rate Description</th>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <th>Tier {{ i }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rate in plan_info['rate_combinations'] %}
                                    <tr>
                                        <td>{{ rate }}</td>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <td>
                                                <input data-summary="Enter Value" type="text" name="contribution_tier{{ i }}_{{ tab_id }}_{{ loop.index }}" class="form-control form-control-sm" placeholder="Enter value">
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- HSA Section -->
                    {% if ("Self" in plan_info['funding_type'] or "Fully" in plan_info['funding_type'] or "Level" in plan_info['funding_type']) and plan_info.loc == "Medical/Rx" %}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>HSA Contributions - Monthly</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th> HSA Rate Description</th>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <th>Tier {{ i }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rate in plan_info['rate_combinations'] %}
                                    <tr>
                                        <td>{{ rate }}</td>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <td>
                                                <input data-summary="Enter Value" type="text" name="hsa_tier{{ i }}_{{ tab_id }}_{{ loop.index }}" class="form-control form-control-sm" placeholder="Enter value">
                                            </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Level Funded Section -->
                    {% if ("Level" in plan_info['funding_type'] ) %}

                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Level Funded Rate Components - Monthly</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Rate Components</th>
                                        {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                            <th>Tier {{ i }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rate_component in ["Admin Fees", "Individual Stop Loss", "Aggregate Stop Loss", "Claims Funding Budget", "Rx Rebate Offset"] %}
                                        <tr>
                                            <td>{{ rate_component }}</td>
                                            {% for i in range(1, plan_info['num_tiers'] + 1) %}
                                                <td>
                                                    <input data-summary="Enter Value" type="text" name="{{ rate_component | replace(' ', '_') }}_tier_{{ i }}" placeholder="Enter value">
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    

                    <!-- Additional Tables -->
                    {% if plan_info['loc'] == "Medical" and "Self" in plan_info['funding_type'] %}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Self-Funded: Indivdual Stop Loss</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Carrier</th>
                                        <th>Contract Type</th>
                                        <th>Deductible</th>
                                        <th>Premium PEPM</th>
                                        <th>Accumulating Policy</th>
                                        <th>Accumulating Deductible</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Carrier Dropdown -->
                                        <td>
                                            <select name="isl_carrier_{{ tab_id }}" class="form-control" data-summary="Enter Value">
                                                <option value="">Select Stop Loss Carrier</option>
                                                {% for carrier in carriers_by_loc['Stop Loss'] %}
                                                    <option value="{{ carrier }}" {% if carrier == existing_stop_loss_carrier %}selected{% endif %}>
                                                        {{ carrier }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                            
                                        <!-- Contract Type -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="isl_contract_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter contract type" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Deductible -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="isl_deductible_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter deductible" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Premium PEPM -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="isl_premium_pepm_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter premium PEPM" 
                                                data-summary="Premium PEPM">
                                        </td>
                            
                                        <!-- Accumulating Policy -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="isl_acc_policy_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter accumulating policy" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Accumulating Deductible -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="isl_acc_deductible_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter accumulating deductible" 
                                                data-summary="Enter Value">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Self-Funded: Aggregate Stop Loss Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Carrier</th>
                                        <th>Expected Claim Liability</th>
                                        <th>Maximum Claim Liability (PEPM)</th>
                                        <th>Corridor</th>
                                        <th>Premium PEPM</th>
                                        <th>Maximum Reimbursement</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Carrier Dropdown -->
                                        <td>
                                            <select name="asl_carrier_{{ tab_id }}" class="form-control" data-summary="Enter Value">
                                                <option value="">Select Stop Loss Carrier</option>
                                                {% for carrier in carriers_by_loc['Stop Loss'] %}
                                                    <option value="{{ carrier }}" {% if carrier == existing_stop_loss_carrier %}selected{% endif %}>
                                                        {{ carrier }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                            
                                        <!-- Expected Claim Liability -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="asl_expected_claim_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter expected claim" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Maximum Claim Liability -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="asl_max_claim_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter maximum claim" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Corridor -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="asl_corridor_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter corridor" 
                                                min="0" 
                                                max="100" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Premium PEPM -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="asl_premium_pepm_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter premium PEPM" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Maximum Reimbursement -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="asl_max_reimbursement_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter max reimbursement" 
                                                data-summary="Enter Value">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                    {% endif %}

                    {% if "Self" in plan_info['funding_type']%}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Self-Funded: Fees</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>PEPM Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Category -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="fees_category_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter category" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Description -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="fees_description_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter description" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- PEPM Amount -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="fees_pepm_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Enter PEPM amount" 
                                                data-summary="Enter Value">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                    {% endif %}

                    {% if "Fully" in plan_info['funding_type'] and plan_info['loc']=="Medical/Rx" %}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Additional Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Pooling Level</th>
                                        <th>Pooling Fee PEPM</th>
                                        <th>Rx Rebate Offset</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Pooling Level -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="pooling_level_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Pooling Level" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Pooling Fee PEPM -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="pooling_fees_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Pooling Fee PEPM" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Rx Rebate Offset -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="rebate_offset_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Rx Rebate Offset" 
                                                data-summary="Enter Value">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                    {% endif %}

                    {% if plan_info['funding_type'] == "Fully-Insured" %}
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>Additional Details</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Calculated Budget</th>
                                        <th>Retention PEPM</th>
                                        <th>Claims Funding PEPM</th>
                                        <th>Rx Rebate Offset</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <!-- Calculated Budget -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="fees_description_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Calculated Budget" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Retention PEPM -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="fees_pepm_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Retention PEPM" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Claims Funding PEPM -->
                                        <td>
                                            <input 
                                                type="text" 
                                                name="fees_description_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Claims Funding PEPM" 
                                                data-summary="Enter Value">
                                        </td>
                            
                                        <!-- Rx Rebate Offset -->
                                        <td>
                                            <input 
                                                type="number" 
                                                name="fees_pepm_{{ tab_id }}" 
                                                class="form-control" 
                                                placeholder="Rx Rebate Offset" 
                                                data-summary="Enter Value">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                    {% endif %}
                </div>
            {% endfor %}

           
            <!-- Summary Tab Content -->
            <div class="tab-pane fade" id="content-summary" role="tabpanel" aria-labelledby="tab-summary">
                <div class="card mt-4 mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5>Summary</h5>
                    </div>
                    <div class="card-body" id="summary-content">
                        <!-- Placeholder for dynamic summary -->
                        <p>No data entered yet.</p>
                    </div>
                </div>
                <!-- Submit Button -->
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary btn-lg">Submit</button>
                </div>
            </div>
        

        </div>

        
    </form>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const summaryContent = document.getElementById('summary-content');
        const form = document.querySelector('form');
    
        // Prevent form submission when pressing Enter in input fields
        form.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.target.tagName === 'INPUT') {
                event.preventDefault(); // Prevent default form submission
            }
        });
    
        const updateSummary = () => {
            summaryContent.innerHTML = ''; // Clear summary content
    
            const tabs = document.querySelectorAll('.tab-pane:not(#content-summary)');
            tabs.forEach(tab => {
                // Get the tab name from the button associated with this tab-pane
                const tabId = tab.id;
                const tabName = document.querySelector(`[aria-controls="${tabId}"]`)?.textContent?.trim() || 'Unnamed Tab';
    
                // Create a section for this tab
                const section = document.createElement('div');
                section.classList.add('summary-section'); // Optional styling class
                section.innerHTML = `<h5>${tabName}</h5>`;
                summaryContent.appendChild(section);
    
                // Clone and process all tables within the current tab
                const tables = tab.querySelectorAll('table');
                if (tables.length === 0) {
                    // If no tables, display a message
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'No data available for this tab.';
                    section.appendChild(noDataMessage);
                } else {
                    tables.forEach(table => {
                        const clonedTable = table.cloneNode(true);
                        clonedTable.querySelectorAll('input, select').forEach(input => {
                            // Skip hidden inputs
                            if (input.type === 'hidden') {
                                return;
                            }
    
                            const cell = input.parentElement;
                            const summaryValue = input.getAttribute('data-summary') || '';
    
                            if (input.tagName === 'SELECT') {
                                // Handle dropdowns
                                const selectedValue = input.options[input.selectedIndex]?.textContent || 'Select value';
                                cell.textContent = summaryValue || selectedValue;
                            } else {
                                // Handle text/number inputs
                                const inputValue = input.value || 'Enter value';
                                cell.textContent = summaryValue || inputValue;
                            }
                        });
                        section.appendChild(clonedTable); // Add table to the section
                    });
                }
            });
    
            if (summaryContent.innerHTML.trim() === '') {
                summaryContent.innerHTML = '<p>No data entered yet.</p>';
            }
        };
    
        // Event listeners for dropdowns
        document.querySelectorAll('select').forEach(dropdown => {
            dropdown.addEventListener('change', (event) => {
                const value = event.target.options[event.target.selectedIndex]?.textContent || '';
                event.target.setAttribute('data-summary', value); // Update data-summary attribute
                updateSummary();
            });
        });
    
        // Event listeners for input fields
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', (event) => {
                const value = event.target.value || '';
                input.setAttribute('data-summary', value); // Update data-summary attribute
                updateSummary();
            });
        });
    
        // Initial population of the summary
        updateSummary();
    });
    
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.addEventListener('click', () => {
        form.submit(); // Explicitly submit the form
    });
    
</script>

<script>
    document.getElementById('submit-button').addEventListener('click', async () => {
        const clientId = "{{ client_id }}"; // Pass ClientId dynamically
        const plans = []; // Array to store plan data
    
        // Loop through each table/row in the Summary tab
        document.querySelectorAll('#summary-content table').forEach(table => {
            const plan = {};
            table.querySelectorAll('input, select').forEach(input => {
                const name = input.name || input.getAttribute('data-summary');
                if (name) {
                    plan[name] = input.value || input.textContent;
                }
            });
            plans.push(plan);
        });
    
        // Send data to the server
        try {
            const response = await fetch(`/client/${clientId}/save_plans`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(plans),
            });
    
            const result = await response.json();
            if (response.ok) {
                alert("Plans saved successfully!");
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            console.error("Failed to save plans:", error);
            alert("An error occurred while saving plans.");
        }
    });
    </script>



<!-- Additional CSS for Styling -->
<style>
    .nav-tabs .nav-link {
        font-weight: bold;
    }
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card-header {
        border-bottom: 2px solid #ddd;
    }
    table.table {
        margin: 0;
        border: 1px solid #ccc;
    }
    table.table th, table.table td {
        text-align: center;
        vertical-align: middle;
    }
    .form-control-sm {
        padding: 0.375rem 0.5rem;
    }

    /* Add spacing between sections (tab groups) */
    #summary-content > div {
        margin-bottom: 2rem; /* Space between tables from different tabs */
        padding: 1rem; /* Add padding to the section */
        border: 1px solid #ddd; /* Add a subtle border for better separation */
        border-radius: 8px;
        background-color: #f9f9f9; /* Light background for distinction */
    }

    /* Style for section headers (tab names) */
    #summary-content > div h5 {
        margin-bottom: 1rem;
        font-weight: bold;
        color: #333;
    }

    /* Style for summary tables */
    #summary-content table {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
        border-spacing: 0;
        background-color: #fff;
    }

    #summary-content table th,
    #summary-content table td {
        padding: 0.75rem;
        text-align: center;
        border: 1px solid #ddd;
    }

    #summary-content table th {
        background-color: #f0f0f0;
        font-weight: bold;
    }
</style>
{% endblock %}
